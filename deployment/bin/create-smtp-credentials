# This script runs on the web instance;
# it uses the AWS API to
# create SMTP credentials so that
# Refinery can access AWS SES.
#
# The JSON result from the command line tool
# is stored in a file (/home/ubuntu/smtp)
# and assigned to the shell environment variables
# EMAIL_HOST_USER and EMAIL_HOST_PASSWORD.
#
# Eventually the values find their way (via Puppet) into
# the Django configuration.

if [ "${IAM_SMTP_USER}" = "" ]
then
    echo 1>&2 "IAM_SMTP_USER environment variable should be set"
    return 99 || exit 99
fi

SMTPFile=/home/ubuntu/smtp

aws iam create-access-key --user-name "${IAM_SMTP_USER}" > "$SMTPFile"

EMAIL_HOST_USER=$(jq -r '.AccessKey.AccessKeyId' < "$SMTPFile")
EMAIL_HOST_PASSWORD=$(jq -r '.AccessKey.SecretAccessKey' < "$SMTPFile")
