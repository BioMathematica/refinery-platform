#!/bin/sh

USER=ubuntu
PASSWORD=${PASSWORD-password}

HOST=$(jq -r .Address /home/ubuntu/rds)
PORT=$(jq -r .Port /home/ubuntu/rds)

psql -c '

DO                
$body$
BEGIN
   IF NOT EXISTS (
      SELECT *
      FROM   pg_catalog.pg_roles
      WHERE  rolname = '"'$USER'"' )
   THEN
      CREATE ROLE '"$USER"' CREATEDB LOGIN PASSWORD '"'$PASSWORD'"';
      GRANT '"$USER"' to root;
   END IF;
END
$body$;

' "postgresql://root:mypassword@${HOST}:${PORT}/postgres"

