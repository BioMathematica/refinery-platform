{% extends "refinery_repository/base.html" %}

{% block head_html %}
<script>

var counter = 0;
var timerId = 0;

function isFinished(result) { 
	var retStatus = false;
	
	if (result.length) 
	var arLen=result.length;
	if (arLen == 1) {
		if ((result[0].task_id == 'SUCCESS') || (result[0].task_id == 'FAILURE')) { 
			retStatus = true;
		}
	}
	return retStatus;	
}

function updateProgress(result, section) { 
	var allFinished = true;
	var arLen=result.length;
	for ( var i=0, len=arLen; i<len; ++i ){
		var temp_id = '#'+result[i].task_id;
		var temp_bar = '#bar_' +result[i].task_id;
		
		//$('element').length == 0; // no element found
		var temp_id = '#text_'+result[i].task_id;
  		$(temp_id).text(JSON.stringify(result[i]));
  		
		if (result[i].state == 'PROGRESS') {
			var temp_percent = result[i].percent_done;
			$(temp_bar).css({ 'width': temp_percent });
		}
		// REMOVING ACTIVE CLASS STATUS
  		if (result[i].state == 'SUCCESS') {
  			$(temp_bar).css({ 'width': '100%'});
  			var temp_bar_class = '#bar_class_'+result[i].task_id;
  			$(temp_bar_class).removeClass('active');
  			$(temp_bar_class).fadeOut('slow');
  			//$("#"+section).collapse("hide");
  			
  		}
  		
  		/*
  		else { 
  			allFinished = false;
  			var temp_percent = result[i].percent_done;
  			$(temp_bar).css({ 'width': temp_percent });
  		}
  		*/
	}
}
 
function getUpdate() {
	
	console.log("counter");
	counter += 1;
	
	
	$.ajax({
     url:"/analysis_manager/{{uuid}}/",
     type:"POST",
     dataType: "json",
     data: {csrfmiddlewaretoken: "{{ csrf_token }}" },
     success: function(result){
     	console.log("ajaxed returned some shit")
     	//console.log(result.preprocessing)
     	//console.log(result.execution)
     	//console.log(result.postprocessing)
     	
     	console.log(counter)
     	
     	updateProgress(result.preprocessing, "collapseOne");
     	updateProgress(result.execution, "collapseTwo");
     	updateProgress(result.postprocessing, "collapseThree");
     	
     	var allFinished = false;
		
		if (isFinished(result.preprocessing) && isFinished(result.execution) && isFinished(result.postprocessing)) {
			allFinished = true;
			console.log("allfinished");
			console.log(allFinished);
		}
		
  		// if all files have been downloaded
  		if (allFinished == true) { 
  			clearTimeout ( timerId );
  		}
  		
  		if (counter == 1000) {
  			console.loge("HIT 1000")
  			clearTimeout ( timerId );
  		}
  		
     }
	});
}


$(document).ready(function() {
	timerId = setInterval(getUpdate, 1000);

});

</script>


{% endblock %}

<!-- 
{% block title %}
{{ block.super }} - Home : 
{% endblock %}

{% block subheader %}
	{% if user.is_authenticated  %}
		ANALYSIS STATUS
	{% else %}
		ANALYSIS STATUS
	{% endif %}
{% endblock %}
-->

{% block content %}
	
{% if statuses %}
<div class="row-fluid">

	<ul>
    <li> Analysis: {{ statuses.analysis_uuid }}<br>
       	{{ statuses.preprocessing_taskset_id }} | {{ statuses.execution_taskset_id }} | {{ statuses.postprocessing_taskset_id }}<br>
        {{ statuses.current }}
    </li>
    </ul>
 </div>
 
    
    <div class="accordion" id="accordion2">
            <div class="accordion-group">
              <div class="accordion-heading">
                <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapseOne">
                  Preprocessing
                </a>
              </div>
              <div id="collapseOne" class="accordion-body collapse in" style="height: auto; ">
                <div class="accordion-inner">
                	{% for stat in statuses.preprocessing_status %}
                		<li>
                		
                		{% if stat.download_url %}
                			<div id="text_{{stat.task_id}}">{{stat}}</div>
                			<div id="bar_class_{{stat.task_id}}" class="progress progress-striped active">
                				<div class="bar" id="bar_{{stat.task_id}}" style="width:{{stat.percent_done}};"></div>
                			</div>
                		{% else %}
                			<div id="text_{{stat.task_id}}">{{stat}}</div>
                		{% endif %}
                		</li>
                		
                		
                	{% endfor %}
                </div>
              </div>
            </div>
            <div class="accordion-group">
              <div class="accordion-heading">
                <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapseTwo">
                  Execution
                </a>
              </div>
              <div id="collapseTwo" class="accordion-body collapse" style="height: auto; ">
                <div class="accordion-inner">
                 	{% for stat in statuses.execution_status %}
                 	<li>
                 		<div id="text_{{stat.task_id}}">{{stat}}</div>
                	<div id="bar_class_{{stat.task_id}}" class="progress progress-striped active">
                		<div class="bar" id="bar_{{stat.task_id}}" style="width:{{stat.percent_done}};"></div>
                	</div>
                	
                	</li>
                	{% endfor %}
                  
                </div>
              </div>
            </div>
            <div class="accordion-group">
              <div class="accordion-heading ">
                <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapseThree">
                  Postprocessing
                </a>
              </div>
              <div id="collapseThree" class="accordion-body collapse" style="height: auto; ">
                <div class="accordion-inner">
                  {% for stat in statuses.postprocessing_status %}
                  	<li>
                  		<div id="text_{{stat.task_id}}">{{stat}}</div>
                	<div id="bar_class_{{stat.task_id}}" class="progress progress-striped active">
                		<div class="bar" id="bar_{{stat.task_id}}" style="width: 0%;"></div>
                	</div>
                	
                	</li>
                	{% endfor %}
                  	{{ statuses.cleanup }}
                  
                </div>
              </div>
            </div>
          </div>
          
    <script>
	
	$(".collapse").collapse("show");

</script>
{% endif %}

{% endblock %}
