{% extends "base.html" %}

{% block head_html %}
    
	<!-- TODO: NEED TO FIX: -->
    <script type="text/javascript" src="{{ STATIC_URL }}js/jquery/jquery-1.7.2.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/bootstrap/js/bootstrap.js"></script>
    
<script>

var counter = 0;
var timerId = 0;

function isFinished(result) { 
	var retStatus = false;
	if (result.length) 
	var arLen=result.length;
	if (arLen == 1) {
		if ((result[0].state == 'SUCCESS') || (result[0].state == 'FAILURE')) { 
			retStatus = true;
		}
	}
	else { 
		for ( var i=0, len=arLen; i<len; ++i ){ 
			if ((result[i].state == 'SUCCESS') || (result[i].state == 'FAILURE')) { 
				retStatus = true;
			}
		}	
	}
	return retStatus;	
}

function updateProgress(result, section) { 
	console.log("updateProgress");
	
	//console.log(result);
	//console.log("TEXTTTT")
	//console.log($.trim($("#collapseOne").text()));
	//console.log($.trim($("#collapseOne > div").text()));
	
	var allFinished = true;
	var arLen=result.length;
	for ( var i=0, len=arLen; i<len; ++i ){
		var temp_id = '#'+result[i].task_id;
		
		if ($(temp_id).length > 0) { // no element found
			var temp_bar = '#bar_' +result[i].task_id;
			var temp_id = '#text_'+result[i].task_id;
	  		$(temp_id).text(JSON.stringify(result[i]));
	  		
			if (result[i].state == 'PROGRESS') {
				var temp_percent = result[i].percent_done;
				$(temp_bar).css({ 'width': temp_percent });
			}
			// REMOVING ACTIVE CLASS STATUS
	  		if (result[i].state == 'SUCCESS') {
	  			$(temp_bar).css({ 'width': '100%'});
	  			var temp_bar_class = '#bar_class_'+result[i].task_id;
	  			//$(temp_bar_class).fadeOut('slow');
	  			$(temp_bar_class).removeClass('active');
	  			$("#"+section).collapse("hide");
	  			//$(temp_bar_class).collapse('hide');
	  			//$("#"+section).collapse("show");
	  		}
  		}
  		else { 
	  		console.log("ELEMENT DOES NOT EXIST \n NEED TO CREATE AND APPEND")
	  		if (result[i].task_id != null) {
	  			var template = 	"<li><div id=" + result[i].task_id+ "> <div id=text_" + result[i].task_id + ">" + result[i] + "</div>";
	  			//if (result[i].percent_download != null) {
	  			//if (result[i].percent_done != null) {
	  			template += "<div id='bar_class_"+ result[i].task_id + "' class='progress progress-striped active'>";
	  			template += "<div class='bar' id='bar_"+ result[i].task_id + "' style='width:{{stat.percent_done}};'></div></div>";
	  			//} 
			    template += "</div></li>";
			    console.log(template);      
			    
			    var cur_text = $.trim($("#"+section + " > div").text());
			    if (cur_text == 'Pending') {
			    	$("#"+section + " > div").html(template);
			    }
			    else { 
			    	$("#"+section + " > div").append(template);
			    }
	
			    $("#"+section).collapse("show");			
		   }
            				
  		}
	}
	
}
 
function getUpdate() {
	
	console.log("counter");
	counter += 1;
	
	
	$.ajax({
     url:"/analysis_manager/{{uuid}}/",
     type:"POST",
     dataType: "json",
     data: {csrfmiddlewaretoken: "{{ csrf_token }}" },
     success: function(result){
     	console.log("ajaxed returned something")
     	//console.log(result.preprocessing)
     	//console.log(result.execution)
     	//console.log(result.postprocessing)
     	
     	console.log(counter)
     	
     	updateProgress(result.preprocessing, "collapseOne");
     	updateProgress(result.execution, "collapseTwo");
     	updateProgress(result.postprocessing, "collapseThree");
     	
     	var allFinished = false;
		
		//if (isFinished(result.preprocessing) && isFinished(result.execution) && isFinished(result.postprocessing)) {
		if (isFinished(result.postprocessing)) {
			allFinished = true;
			console.log("allfinished");
			console.log(allFinished);
		}
		
  		// if all files have been downloaded
  		if (allFinished == true) { 
  			clearTimeout ( timerId );
  			// GOING TO ANALYSIS RESULTS PAGE
  			//var url = "/analysis_manager/{{uuid}}/results"
  			var url = "/projects/{{ user.get_profile.catch_all_project.uuid }}/analyses/{{ statuses.analysis.uuid }}";
  			//<i class="icon-empty"></i> <a href="projects/{{ user.get_profile.catch_all_project.uuid }}/analyses/{{ analysis.uuid }}">{{ analysis.name }} - {{analysis.summary}}</a>
  			console.log(url);
  			//window.location = url;
  		}
  		
  		if (counter == 1000) {
  			console.log("HIT 1000")
  			clearTimeout ( timerId );
  		}
  		
  		console.log("allfinished");
		console.log(allFinished);
  		
  		
     }
	});
}


$(document).ready(function() {
	timerId = setInterval(getUpdate, 2800);

});

</script>


{% endblock %}


{% block content %}
	
{% if statuses %}
<div class="row-fluid">

	<ul>
    <li> Analysis: {{ statuses.analysis_uuid }}<br>
       	{{ statuses.preprocessing_taskset_id }} | {{ statuses.execution_taskset_id }} | {{ statuses.postprocessing_taskset_id }}<br>
        {{ statuses.current }}
    </li>
    </ul>
 </div>
 
    
    <div class="accordion" id="accordion2">
            <div class="accordion-group">
              <div class="accordion-heading">
                <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapseOne">
                  Preprocessing
                </a>
              </div>
              <div id="collapseOne" class="accordion-body collapse in" style="height: auto; ">
                <div class="accordion-inner">
                	{% for stat in statuses.preprocessing_status %}
            			<li>
            			{% if preprocessing_status|length > 1 and stat.task_id == null %}
   							Pending
						{% else %}
							<div id="{{stat.task_id}}">
	            				<div id="text_{{stat.task_id}}">{{stat}}</div>
		            			{% if stat.percent_done %}
		            				<div id="bar_class_{{stat.task_id}}" class="progress progress-striped active">
		            					<div class="bar" id="bar_{{stat.task_id}}" style="width:{{stat.percent_done}};"></div>
		            				</div>
		            			{% endif %}
		            		</div>
            			</li>
            			{% endif %}
            		{% endfor %}
            		
                	
                </div>
              </div>
            </div>
            <div class="accordion-group">
              <div class="accordion-heading">
                <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapseTwo">
                  Execution
                </a>
              </div>
              <div id="collapseTwo" class="accordion-body collapse" style="height: auto; ">
                <div class="accordion-inner">
                 	{% for stat in statuses.execution_status %}
                 		<li>
                 		{% if execution_status|length > 1 and stat.task_id == null %}
   							Pending
						{% else %}
							<div id="{{stat.task_id}}">
	                 			<div id="text_{{stat.task_id}}">{{stat}}</div>
	                			<div id="bar_class_{{stat.task_id}}" class="progress progress-striped active">
	                				<div class="bar" id="bar_{{stat.task_id}}" style="width:{{stat.percent_done}};"></div>
	                			</div>
	                		</div>
                		{% endif %}
                	</li>
                	{% endfor %}
                  
                </div>
              </div>
            </div>
            <div class="accordion-group">
              <div class="accordion-heading ">
                <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapseThree">
                  Postprocessing
                </a>
              </div>
              <div id="collapseThree" class="accordion-body collapse" style="height: auto; ">
                <div class="accordion-inner">
                  {% for stat in statuses.postprocessing_status %}
                  		<li>
                  		{% if postprocessing_status|length > 1 and stat.task_id == null %}
   							Pending
						{% else %}
							<div id="{{stat.task_id}}">
	                  			<div id="text_{{stat.task_id}}">{{stat}}</div>
	                  			{% if stat.percent_done %}
	                			<div id="bar_class_{{stat.task_id}}" class="progress progress-striped active">
	                				<div class="bar" id="bar_{{stat.task_id}}" style="width: 0%;"></div>
	                			</div>
	                			{% endif %}
	                		</div>
	                	{% endif %}
                	</li>
                	{% endfor %}
                  	{{ statuses.cleanup }}
                  
                </div>
              </div>
            </div>
          </div>
          
    <script>
	
	$(".collapse").collapse("show").height('auto');

</script>
{% endif %}

{% endblock %}
