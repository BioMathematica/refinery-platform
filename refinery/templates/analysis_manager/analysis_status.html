{% extends "base.html" %}

{% block head_html %}
    
        <script type="text/javascript" src="{{ STATIC_URL }}js/jquery/jquery-1.7.2.js"></script>
    
	<!-- 3rd party libraries -->
    <script type="text/javascript" src="{{ STATIC_URL }}js/bootstrap/js/bootstrap.js"></script>

<script>

var counter = 0;
var timerId = 0;

function isFinished(result) { 
	var retStatus = false;
	if (result.length) 
	var arLen=result.length;
	if (arLen == 1) {
		if ((result[0].state == 'SUCCESS') || (result[0].state == 'FAILURE')) { 
			retStatus = true;
		}
	}
	else { 
		for ( var i=0, len=arLen; i<len; ++i ){ 
			if ((result[i].state == 'SUCCESS') || (result[i].state == 'FAILURE')) { 
				retStatus = true;
			}
		}	
	}
	return retStatus;	
}

function updateProgress(result, section) { 
	console.log("------------- updateProgress");
	console.log($("#"+section));
				
	
	//console.log(result);
	//console.log("TEXTTTT")
	//console.log($.trim($("#collapseOne").text()));
	//console.log($.trim($("#collapseOne > div").text()));
	
	var allFinished = true;
	var arLen=result.length;
	for ( var i=0, len=arLen; i<len; ++i ){
		var temp_id = '#'+result[i].task_id;
		
		if ($(temp_id).length > 0) { // no element found
			var temp_bar = '#bar_' +result[i].task_id;
			var temp_id = '#text_'+result[i].task_id;
			var temp_progress = '#progress_' +result[i].task_id;
	  		$(temp_id).text(JSON.stringify(result[i]));
	  		
	  		console.log(result[i]);
	  		
			if (result[i].state == 'PROGRESS') {
				console.log("PROGRESS ");
	  			
				var temp_percent = result[i].percent_done;
				$(temp_bar).css({ 'width': temp_percent });
				$(temp_progress).html( Math.floor( temp_percent.replace("%","") ) + "%" );
				
				console.log($("#"+section));
				
				//var cur_text = $.trim($("#"+section + " > div").text());
			    //if (cur_text == 'Pending') {
			    //	$("#"+section).collapse("show");
			    //}
				
			}
			// REMOVING ACTIVE CLASS STATUS
	  		if (result[i].state == 'SUCCESS') {
	  			console.log("SUCCESS ");
	  			
	  			$(temp_bar).css({ 'width': '100%'});
				$(temp_progress).html( "100%");


	  			var indicator_id = '#indicator_'+result[i].task_id;
	  			$(indicator_id).fadeOut('slow');
	  			$(indicator_id).removeClass('active');
				
				/*
	  			var temp_bar_class = '#bar_class_'+result[i].task_id;
	  			$(temp_bar_class).fadeOut('slow');
	  			$(temp_bar_class).removeClass('active');
	  			*/
	  			
	  			//$("#"+section).collapse("hide");
	  			//$(temp_bar_class).collapse('hide');
	  			//$("#"+section).collapse("show");
	  		}
  		}
  		else { 
	  		if (result[i].task_id != null) {
	  			console.log("ELEMENT DOES NOT EXIST \n NEED TO CREATE AND APPEND")
	  		
	  			var template = 	"<li><div id=" + result[i].task_id+ "> <div id=text_" + result[i].task_id + ">" + result[i] + "</div>";
	  			//if (result[i].percent_download != null) {
	  			//if (result[i].percent_done != null) {
	  			template += "<div id='bar_class_"+ result[i].task_id + "' class='progress progress-striped active'>";
	  			template += "<div class='bar' id='bar_"+ result[i].task_id + "' style='width:{{stat.percent_done}};'></div></div>";
	  			//} 
			    template += "</div></li>";
			    //console.log(template);      
			    
			    var cur_text = $.trim($("#"+section + " > div").text());
			    if (cur_text == 'Pending') {
			    	$("#"+section + " > div").html(template);
			    }
			    else { 
			    	$("#"+section + " > div").append(template);
			    }
	
			    //$("#"+section).collapse("show");			
		   }
            				
  		}
	}
	
}
 
function getUpdate() {
	
	console.log("counter");
	counter += 1;
	
	
	$.ajax({
     url:"/analysis_manager/{{uuid}}/",
     type:"POST",
     dataType: "json",
     data: {csrfmiddlewaretoken: "{{ csrf_token }}" },
     success: function(result){
     	console.log("ajaxed returned something")
     	console.log(counter)
     	
     	updateProgress(result.preprocessing, "collapseOne");
     	updateProgress(result.execution, "collapseTwo");
     	updateProgress(result.postprocessing, "collapseThree");
     	
     	var allFinished = false;
		
		//if (isFinished(result.preprocessing) && isFinished(result.execution) && isFinished(result.postprocessing)) {
		if (isFinished(result.postprocessing)) {
			allFinished = true;
			console.log("allfinished");
			console.log(allFinished);
		}
		
  		// if all files have been downloaded
  		if (allFinished == true) { 
  			clearTimeout ( timerId );
  			// GOING TO ANALYSIS RESULTS PAGE
  			//var url = "/analysis_manager/{{uuid}}/results"
  			var url = "/projects/{{ user.get_profile.catch_all_project.uuid }}/analyses/{{ statuses.analysis.uuid }}";
  			//<i class="icon-empty"></i> <a href="projects/{{ user.get_profile.catch_all_project.uuid }}/analyses/{{ analysis.uuid }}">{{ analysis.name }} - {{analysis.summary}}</a>
  			
  			//DEBUG
  			window.location = url;
  		}
  		
  		if (counter == 1000) {
  			console.log("HIT 1000")
  			clearTimeout ( timerId );
  		}
  		
  		console.log("allfinished");
		console.log(allFinished);
  		
  		
     }
	});
}


$(document).ready(function() {
	timerId = setInterval(getUpdate, 2800);

});

</script>


{% endblock %}

{% block subheader %}
<h1 class="page-header">Analysis <small>{{ statuses.analysis.name }}</small></h1>
{% endblock %}


{% block content %}
	
	{% if statuses %}
		<div class="row-fluid">
			<div class="span4">

	          <h3>Preprocessing</h3>
	
	        	{% for stat in statuses.preprocessing_status %}
	    			<div>
	    			{% if preprocessing_status|length > 1 and stat.task_id == null %}
						<div class="alert alert-info"><strong>Waiting</strong> Preprocessing pending.</div>
					{% else %}
						<div id="{{stat.task_id}}">
	            			{% if stat.percent_done %}
		             			<div class="row-fluid" id="indicator_{{stat.task_id}}">	                 				
		             				<div class="span10">
		            					<div id="bar_class_{{stat.task_id}}" class="progress progress-striped active">
		            						<div class="bar" id="bar_{{stat.task_id}}" style="width:{{stat.percent_done}};"></div>
		             					</div>
		             				</div>
		             				<div class="span2">
		             					<strong id="progress_{{stat.task_id}}">{{stat.percent_done}}</strong>
		             				</div>
		                		</div>
	            			{% else %}
	            				{% if stat.state == "SUCCESS" %}
		   							<div class="alert alert-success"><strong>Success</strong> Preprocessing completed.</div>		            				
		            			{% endif %}
	            				{% if stat.state == "FAILURE" %}
		   							<div class="alert alert-error"><strong>Error</strong> Preprocessing failed.</div>		            				
		            			{% endif %}
	            			{% endif %}
	            		</div>
	    			{% endif %}
	    			</div>
	    		{% endfor %}
            		
            
 			</div> <!-- column -->
 			<div class="span4">
 
              <h3>Execution</h3>
              
             	{% for stat in statuses.execution_status %}
             		<div>
             		{% if execution_status|length > 1 and stat.task_id == null %}
						<div class="alert alert-info"><strong>Waiting</strong> Workflow pending.</div>
					{% else %}
						<div id="{{stat.task_id}}">
	            			{% if stat.percent_done %}							
		             			<!-- <div id="text_{{stat.task_id}}">{{stat}}</div> -->
		             			<div class="row-fluid" id="indicator_{{stat.task_id}}">	                 				
		             				<div class="span10">
		            					<div id="bar_class_{{stat.task_id}}" class="progress progress-striped active">
		            						<div class="bar" id="bar_{{stat.task_id}}" style="width:{{stat.percent_done}};"></div>
		             					</div>
		             				</div>
		             				<div class="span2">
		             					<strong id="progress_{{stat.task_id}}">{{stat.percent_done}}</strong>
		             				</div>
		                		</div>
		                	{% else %}
	            				{% if stat.state == "SUCCESS" %}
		   							<div class="alert alert-success"><strong>Success</strong> Execution completed.</div>		            				
		            			{% endif %}
	            				{% if stat.state == "FAILURE" %}
		   							<div class="alert alert-error"><strong>Error</strong> Execution failed.</div>		            				
		            			{% endif %}			                	
		                	{% endif %}
						</div>
            		{% endif %}
            	</div>
            	{% endfor %}                  
            
			 </div> <!-- column -->
			 <div class="span4">
			            
              <h3>Postprocessing</h3>

              {% for stat in statuses.postprocessing_status %}
              	<div>
              		{% if postprocessing_status|length > 1 and stat.task_id == null %}
						<div class="alert alert-info"><strong>Waiting</strong> Postprocessing pending.</div>
					{% else %}
						<div id="{{stat.task_id}}">
	            			{% if stat.percent_done %}							
		             			<!-- <div id="text_{{stat.task_id}}">{{stat}}</div> -->
		             			<div class="row-fluid" id="indicator_{{stat.task_id}}">	                 				
		             				<div class="span10">
		            					<div id="bar_class_{{stat.task_id}}" class="progress progress-striped active">
		            						<div class="bar" id="bar_{{stat.task_id}}" style="width:{{stat.percent_done}};"></div>
		             					</div>
		             				</div>
		             				<div class="span2">
		             					<strong id="progress_{{stat.task_id}}">{{stat.percent_done}}</strong>
		             				</div>
		                		</div>
		                	{% else %}
	            				{% if stat.state == "SUCCESS" %}
		   							<div class="alert alert-success"><strong>Success</strong> Execution completed.</div>		            				
		            			{% endif %}
	            				{% if stat.state == "FAILURE" %}
		   							<div class="alert alert-error"><strong>Error</strong> Execution failed.</div>		            				
		            			{% endif %}			                	
		                	{% endif %}
						</div>							
                	{% endif %}
            	</div>
            	{% endfor %}
                
                {{ statuses.cleanup }}
            
			</div> <!-- column --> 
			</div>
                  
{% endif %}

{% endblock %}

