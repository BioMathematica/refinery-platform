{% extends "base.html" %}

{% load static %}

{% block title %}
{{ block.super }} - Home
{% endblock %}

{% block head_html %}
<link href="{% static 'styles/css/animate.css' %}" rel="stylesheet">
{% endblock %}

{% block subheader %}
  <div class="page-header">
    <h1>
      Launch Pad
    {% if user.is_authenticated %}
      <small>
        {% if user.first_name != "" or user.last_name != "" %}
          {{ user.first_name }} {{ user.last_name }}
        {% else %}
          {{ user.username }}
        {% endif %}
      </small>
      <div id="user-id" style="display:none;">{{ user.id }}</div>
    {% endif %}
  </h1>
  </div>
{% endblock %}

{% block content %}
{% if users %}
  <!-- only super users get to see this -->
  <!--
  <h2>Users ({{ users|length}})</h2>
    <ul>
    {% for user in users %}
        <li><a href="users/{{ user.username }}">{{ user.username }}</a>: {{ user.first_name }} {{ user.last_name }} ({{ user.get_profile.affiliation }}): {{ user.email }}</li>
    {% endfor %}
    </ul>
   -->
{% endif %}

<div class="row-fluid refinery-dashboard" ng-controller="DashboardCtrl as dashboard" ui-view></div>

{% endblock %}

{% block script %}
  <script src="{% static 'js/dashboard.js' %}"></script>

  <script
    type="text/javascript"
    src="{{ STATIC_URL }}js/refinery/analysis_manager/analysis_monitor.js">
  </script>

  <script>
    $(document).ready(function() {
      var monitors = [];
      var callbacks = [];
      var intervalIds = [];

      {% for analysis in unassigned_analyses.all %}
        {% if analysis.status != "SUCCESS" and analysis.status != "FAILURE" %}
          {
              monitors["{{ analysis.uuid }}"] = new AnalysisMonitor(
                      "{{ analysis.uuid }}",
                      document.location.protocol + "//" + document.location.host,
                      "",
                      "{{ csrf_token }}"
              );

              callbacks["{{ analysis.uuid }}"] = function () {
                  monitors["{{ analysis.uuid }}"].getAnalysisProgress(
                          function (percentDone) {
                              $("#analysis-{{ analysis.uuid }}-status")
                                      .html("<span class=\"badge\"><i class=\"icon-cog icon-spin\"></i>&nbsp;" + percentDone + "</span>");
                          },
                          function (result) {
                              if (result.overall === 'SUCCESS') {
                                  $("#analysis-{{ analysis.uuid }}-status")
                                          .html("<span class=\"badge badge-info\"><i class=\"icon-ok\"></i></span>");
                              }
                              else {
                                  $("#analysis-{{ analysis.uuid }}-status")
                                          .html("<span class=\"badge badge-info\"><i class=\"icon-warning-sign\"></i></span>");
                              }
                              // analysis has finished successfully - no more monitoring required
                              clearInterval(intervalIds["{{ analysis.uuid }}"]);
                              delete callbacks["{{ analysis.uuid }}"];
                              delete monitors["{{ analysis.uuid }}"];
                          }
                  );
              };

              //monitors["{{ analysis.uuid }}"].isAnalysisRunning( callbacks["{{ analysis.uuid }}"]() );
              callbacks["{{ analysis.uuid }}"]();

              intervalIds["{{ analysis.uuid }}"] = setInterval(callbacks["{{ analysis.uuid }}"], 5000);
          }
          {% endif %}
      {% endfor %}
    });
  </script>
{% endblock %}
