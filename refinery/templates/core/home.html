{% extends "base.html" %}

{% block title %}
{{ block.super }} - Home
{% endblock %}

{% block subheader %}
  <div class="page-header">
  	<h1>
  		Launch Pad
		{% if user.is_authenticated %}
			<small>
				{% if user.first_name != "" or user.last_name != "" %}
					{{ user.first_name }} {{ user.last_name }}
				{% else %}
					{{ user.username }}				
				{% endif %}
			</small>
		{% endif %} 
	</h1>  	  	
  </div>
{% endblock %}

{% block content %}
{% if users %}
	<!-- only super users get to see this -->
	<!--
	<h2>Users ({{ users|length}})</h2> 
    <ul>
    {% for user in users %}
        <li><a href="users/{{ user.username }}">{{ user.username }}</a>: {{ user.first_name }} {{ user.last_name }} ({{ user.get_profile.affiliation }}): {{ user.email }}</li>
    {% endfor %}
    </ul>
   -->
{% endif %}

<div class="row-fluid">
 <div class="span4">

<div class="refinery-panel refinery-panel-content scrollable">
<div class="refinery-header">
	<span class="refinery-header-left">
		<h3><i class="icon-folder-open"></i>&nbsp;&nbsp;Projects</h3>
	</span>

	{% if user.is_authenticated %}       
		<span class="refinery-header-right">
			<h4><a href="{% url project_new %}"><i class="icon-plus-sign"></i></a></h4> 
		</span>	
	{% endif %}		
</div>


{% if projects or unassigned_analyses %}

<table class="table table-striped table-condensed">
	<thead>
		<tr>
			<th>
				Name
			</th>    
			<th>
				Analyses
			</th>    
		</tr>
	</thead>
	<tbody>
		
	{% if unassigned_analyses %}
		{% if unassigned_analyses.all|length > 0 %}
		    <tr>
		    	<td>
		        	<i class="icon-exclamation-sign"></i> Unassigned Analyses
		        </td>
		    	<td>
		        	{{unassigned_analyses.all|length}}
		        </td>
		    </tr>
			{% for analysis in unassigned_analyses.all %}
			    <tr>
			    	<td>
			    		<!-- <i class="icon-empty"></i> <a href="projects/{{ user.get_profile.catch_all_project.uuid }}/analyses/{{ analysis.uuid }}">{{ analysis.name }}</a> -->
			    		<a href="{% url analysis_status analysis.uuid %}">{{ analysis.name }}</a>
			    	</td>
			    	<td>
			    		<span id="analysis-{{ analysis.uuid }}-status"></span>
			    	</td>
			    </tr>
			{% endfor %}	
		{% endif %}
	{% endif %}

    {% for project in projects %}
    <tr>
    	<td>
        	<a href="{% url project project.uuid %}">{{ project.name }}</a>
        </td>
    	<td>
        {{project.analyses.all|length}}
        </td>
    </tr>
		{% for analysis in project.analyses.all %}
		    <tr>
		    	<td>
		    		<!-- <a href="projects/{{ project.uuid }}/analyses/{{ analysis.uuid }}">{{ analysis.name }}</a> - {{analysis.summary}} -->
		    		<a href="{% url analysis_status analysis.uuid %}">{{ analysis.name }}</a> - {{analysis.summary}}
		    	</td>
			    <td>
					<span id="status-{{ analysis.uuid }}"></span>
			    </td>
		    </tr>
		{% endfor %}
    {% endfor %}
		
	</tbody>
</table>
{% else %}

	<div class="alert alert-info">
		{% if user.is_authenticated %}       
			No projects available.
		{% else %}
			No public projects available.
		{% endif %}		  
	</div>
{% endif %}
</div> 		


</div>
<div class="span4">

<div class="refinery-panel refinery-panel-content scrollable">
	
<div class="refinery-header">
	<span class="refinery-header-left">
		<h3><i class="icon-cog"></i>&nbsp;&nbsp;Workflows</h3>
	</span>
</div>
	
{% if workflows %}
	<table class="table table-striped table-condensed">
		<thead>
			<tr>
				<th>
					Name
				</th>    
			</tr>
		</thead>
		<tbody>
		{% for workflow in workflows %}
        <tr>
        	<td>
        		<a href="{% url workflow workflow.uuid %}">{{ workflow.name }}</a>
        	</td>
        </tr>
    	{% endfor %}
		</tbody>		
	</table>
{% else %}
	<div class="alert alert-info">
		{% if user.is_authenticated %}       
			No workflows available.
		{% else %}
			No public workflows available.
		{% endif %}		  
	</div>
{% endif %}
	
</div>
</div>

<div class="span4">

<div class="refinery-panel refinery-panel-content scrollable">
<div class="refinery-header">
	<span class="refinery-header-left">
		<h3><i class="icon-file"></i>&nbsp;&nbsp;Data Sets</h3>
	</span>
	{% if user.is_authenticated %}       
		<span class="refinery-header-right">
			<h4><a href={% url import_isa_tab %}><i class="icon-plus-sign"></i></a></h4>
		</span> 
	{% endif %}				
</div>

{% if data_sets %}	
	<table class="table table-striped table-condensed">
		<thead>
			<tr>
				<th>
					Name
				</th>    
				<!--
				<th>
					Owner
				</th>
				-->    
			</tr>
		</thead>
		<tbody>
    {% for data_set in data_sets %}
        <tr>
        	<td>
				<a href="{% url data_set data_set.uuid %}">{{ data_set.name }}</a>        		
        	</td>
        </tr>
    {% endfor %}
		</tbody>		
	</table>
	 
{% else %}
	<div class="alert alert-info">
		{% if user.is_authenticated %}       
			No data sets available.
		{% else %}
			No public data sets available.
		{% endif %}		  
	</div>
{% endif %}

</div>

	
</div>

</div>
{% endblock %}

{% block script %}
    <script type="text/javascript" src="{{ STATIC_URL }}js/refinery/analysis_manager/analysis_monitor.js"></script>
	
	<script>	    	
		$(document).ready(function() {		
			var monitors = [];
			var callbacks = [];
			{% for analysis in unassigned_analyses.all %}
				monitors["{{ analysis.uuid }}"] = new AnalysisMonitor( "{{ analysis.uuid }}", "http://{{ REFINERY_BASE_URL }}", "", "{{ csrf_token }}" );
				
				callbacks["{{ analysis.uuid }}"] = function(){ monitors["{{ analysis.uuid }}"].getAnalysisProgress( function( percentDone ) {
					$( "#analysis-{{ analysis.uuid }}-status" ).html( "<span class=\"badge\">" + percentDone + "</span>" );
				}, function() {
					$( "#analysis-{{ analysis.uuid }}-status" ).html( "<span class=\"badge badge-info\"><i class=\"icon-ok\"></i></span>" );
				} )};
				
				//monitors["{{ analysis.uuid }}"].isAnalysisRunning( callbacks["{{ analysis.uuid }}"]() );
				callbacks["{{ analysis.uuid }}"]();			
				
				setInterval( callbacks["{{ analysis.uuid }}"], 5000 );
			{% endfor %}
		});    		
	</script>
{% endblock %}


