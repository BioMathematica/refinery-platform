{% extends "core/base.html" %}
{% block content %}

{% if investigation %}
    <h3>{{investigation.study_identifier}}: {{investigation.study_title}}</h3>
    
    {# fetches all investigators associated with current investigation #}
    {% for i in investigation.investigator_set.all %}
    	<h4>{{i}} &lt;{{i.study_person_email}}&gt; {{i.study_person_affiliation}}</h4>
    {% endfor %}
    
    <p>{{investigation.study_description}}</p>
    {% if error_message %}<p><strong>{{error_message}}</strong></p>{% endif %}
    <form action="/refinery_repository/{{investigation.study_identifier}}/download/" method="post">
    {% csrf_token %}
    	<ul>
    	{# iterates over all of the study files assoc. with investigation #}
    	{% for study in investigation.study_set.all %}
    		<li>
    			<p>Source Name: {{study.source_name}}</p>
    			<p>Sample Name: {{study.sample_name}}</p>
    			
    			{% if study.protocols.all %}
    			<p>Protocols:</p>
    			<ul>
    			{% for p in study.protocols.all %}
    				<li>
    					<p>{{p.study_protocol_name}}</p>
    				</li>
    			{% endfor %}
    			</ul>
    			{% endif %}
    			{% if study.comment_set %}
    			<p>Comments:</p>
    			<table>
   					<tr>
   	    			{# grabs all factor values associated with "a" via fk #}
    				{% for c in study.comment_set %}
    					<th>
   							{# header is subtype #}
							{{c.sub_type}}
    					</th>
    				{% endfor %}
	   				</tr>
   					<tr>
    				{% for c in study.comment_set %}
    					<td>
    						{{c.value}}
    					</td>
    				{% endfor %}
	    			</tr>
    			</table>
    			{% endif %}
    			{% if study.characteristics_set %}
    			<p>Characterisitics:</p>
    			<table>
   					<tr>
   	    			{# grabs all factor values associated with "a" via fk #}
    				{% for c in study.characteristics_set %}
    					<th>
   							{# header is subtype #}
							{{c.sub_type}}
    					</th>
    				{% endfor %}
	   				</tr>
   					<tr>
    				{% for c in study.characteristics_set %}
    					<td>
    						{{c.value}}
    					</td>
    				{% endfor %}
	    			</tr>
    			</table>
    			{% endif %}
    			
    			<p>Assays:</p>
    			<ul>
	    		{# iterates over all of the assay files assoc. with study#}
    			{% for a in study.assay_set.all %}
    				<li>
    					<p>{{a.sample_name}}</p>
    					{% if a.protocols.all %}
    					<p>Protocols:</p>
    					<ul>
    					{% for p in a.protocols.all %}
    						<li>
    							<p>{{p.study_protocol_name}}</p>
    						</li>
    					{% endfor %}
    					</ul>
    					{% endif %}
    					{% if a.factorvalue_set %}
    					Factor Values:
    					<table>
    						<tr>
	    					{# grabs all factor values associated with "a" via fk #}
    						{% for f in a.factorvalue_set %}
    							<th>
    								{# header is subtype #}
    								{{f.sub_type}}
    							</th>
    						{% endfor %}
	    					</tr>
    						<tr>
    						{% for f in a.factorvalue_set %}
    							<td>
    								{{f.value}}
    							</td>
    						{% endfor %}
	    					</tr>
    					</table>
    					{% endif %}
    					{% if a.parametervalue_set %}
    					Parameter Values:
    					<table>
    						<tr>
	    					{# grabs all factor values associated with "a" via fk #}
    						{% for p in a.parametervalue_set %}
    							<th>
    								{# header is subtype #}
    								{{p.sub_type}}
    							</th>
    						{% endfor %}
	    					</tr>
    						<tr>
    						{% for p in a.parametervalue_set %}
    							<td>
    								{{p.value}}
    							</td>
    						{% endfor %}
	    					</tr>
    					</table>
    					{% endif %}
    					{% if a.comment_set %}
    					Comments:
    					<table>
    						<tr>
	    					{# grabs all factor values associated with "a" via fk #}
    						{% for c in a.comment_set %}
    							<th>
    								{# header is subtype #}
    								{{c.sub_type}}
    							</th>
    						{% endfor %}
	    					</tr>
    						<tr>
    						{% for c in a.comment_set %}
    							<td>
    								{{c.value}}
    							</td>
    						{% endfor %}
	    					</tr>
    					</table>
    					{% endif %}
    					{% if a.raw_data.all %}
    					Raw File(s):
    					<table>
    						<tr>
	    					{# to get many-to-many, assay.other_table.all #}
    						{% for r in a.raw_data.all %}
    							<td>
    								<input type="checkbox" name="{{r}}" id="{{r}}" />
									<label for="{{r}}">{{r}}</label>
	    						</td>
    						{% endfor %}
    						</tr>
    					</table>
    					{% endif %}
	    				{% if a.processed_data.all %}
	    				Processed File(s):
    					<table>
    						<tr>
    						{% for p in a.processed_data.all %}
    							<td>
    								<input type="checkbox" name="{{p}}" id="{{p}}" />
									<label for="{{p}}">{{p.derived_data_file}}</label>
	    						</td>
	    					{% endfor %}
    						</tr>
    					</table>
    					{% endif %}
    				</li>
    			{% endfor %}
    			</ul>
    	{% endfor %}
    		</li>
    	</ul>
    	<input type="submit" value="Submit" />
    </form>
    
{% else %}
    <p>No information for this investigation is available.</p>
{% endif %}

{% endblock %}
