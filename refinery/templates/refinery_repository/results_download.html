{% extends "base.html" %}

{% block head_html %}
<script>

var counter = 0;
var timerId = 0;

function getUpdate() {
	
	counter += 1;

	$.ajax({
     url:"/refinery_repository/results/",
     type:"POST",
     dataType: "json",
     data: {csrfmiddlewaretoken: "{{ csrf_token }}" },
     success: function(result){
     	// EXAMPLE JSON RETURN
     	//{'task_id': '38a4e411-2d0c-421c-b32f-a7c33e5b5f3e', 'download_location': u'/Users/richardpark/Desktop/refinery_downloads/E-GEOD-11074/SRR001655.fastq.gz', 'download_url': u'ftp://ftp.sra.ebi.ac.uk/vol1/fastq/SRR001/SRR001655/SRR001655.fastq.gz', 'current': 1254656, 'state': u'PROGRESS', 'percent_done': '0.18%', 'total': 694369271} 
        
        var arLen=result.length;
        var allFinished = true;
		for ( var i=0, len=arLen; i<len; ++i ){
  			var temp_id = '#'+result[i].task_id;
  			$(temp_id).text(JSON.stringify(result[i]));
  		
  			var temp_bar = '#bar_' +result[i].task_id;
  			
  			// REMOVING ACTIVE CLASS STATUS
  			if (result[i].state == 'SUCCESS') {
  				$(temp_bar).css({ 'width': '100%'});
  				var temp_bar_class = '#bar_class_'+result[i].task_id;
  				$(temp_bar_class).removeClass('active');
  				$(temp_bar_class).fadeOut('slow');
  			}
  			else { 
  				allFinished = false;
  				var temp_percent = result[i].percent_done;
  				$(temp_bar).css({ 'width': temp_percent });
  			}
  		}

  		// if all files have been downloaded
  		if (allFinished == true) { 
  			clearTimeout ( timerId );
  		}
  		
     }
	});
}


$(document).ready(function() {
	timerId = setInterval(getUpdate, 1000);
});

</script>


{% endblock %}

{% block content %}

<h1>{{ investigation.study_identifier }}</h1>

<p>
	Successfully submitted Data for Processing.  Refresh the page to see the
	progress of your analysis.
</p>
<h1>Task Progress</h1>
<ul>
	{% for task in task_progress %}
	<li> <div id="{{task.task_id}}"> {{task}} </div></li>
	
	<div id="bar_class_{{task.task_id}}" class="progress progress-striped active">
  		<div class="bar" id="bar_{{task.task_id}}" style="width: 0%;"></div>
    </div>
	
	{% endfor %}
</ul>
<a href="/refinery_repository/cancelled/">Cancel Downloads?</a>
<br />
<a href="/refinery_repository/">Analyze another?</a>


{% endblock %}
