/*! refinery-platform-ui 2015-06-16 */

var DATA_SET_UI_MODE_BROWSE="browse",DATA_SET_UI_MODE_ANALYZE="analyze",DATA_SET_UI_MODE_VISUALIZE="visualize",currentDataSetUiMode=DATA_SET_UI_MODE_BROWSE;angular.module("ngResource").config(["$provide","$httpProvider",function(a,b){a.decorator("$resource",["$delegate",function(a){return function(){"use strict";return arguments.length>0&&(arguments[0]=arguments[0].replace(/\/$/,"\\/")),arguments.length>2&&angular.forEach(arguments[2],function(a){a&&a.url&&(a.url=a.url.replace(/\/$/,"\\/"))}),a.apply(a,arguments)}}]),a.factory("resourceEnforceSlashInterceptor",function(){return{request:function(a){return a.url=a.url.replace(/[\/\\]+$/,"/"),a}}}),b.interceptors.push("resourceEnforceSlashInterceptor")}]),angular.module("refineryNodeMapping",["ui.select2","ui.bootstrap","ui.router","ngResource","refineryWorkflows","refinerySolr","ui.bootstrap"]).config(["$httpProvider",function(a){a.defaults.xsrfCookieName="csrftoken",a.defaults.xsrfHeaderName="X-CSRFToken"}]).config(["$stateProvider",function(a,b,c,d){a.state("browse",{templateUrl:"/static/partials/data_set_ui_mode_browse.html",controller:["$scope","$rootScope","$timeout","$",function(a,b,c,d){b.mode="browse",b.showCtrlTab=!1,b.mainTabSpanSize="span12 no-margin",b.ctrlTabSpanSize="",c(sizing,0),d(window).trigger("refinery/floatThead/reflow")}]}),a.state("analyze",{templateUrl:"/static/partials/data_set_ui_mode_analyze.html",controller:["$scope","$rootScope","$timeout","$window","$",function(a,b,c,d,e){b.mode="analyze",b.showCtrlTab=!0,b.mainTabSpanSize="span10",b.ctrlTabSpanSize="span2",c(sizing,0),e(window).trigger("refinery/floatThead/reflow")}]}),a.state("visualize",{templateUrl:"/static/partials/data_set_ui_mode_visualize.html",controller:["$scope","$rootScope","$timeout","$window","$",function(a,b,c,d,e){b.mode="visualize",b.showCtrlTab=!0,b.mainTabSpanSize="span10",b.ctrlTabSpanSize="span2",c(sizing,0),e(window).trigger("refinery/floatThead/reflow")}]})}]).directive("nodeDraggable",function(){return{restrict:"A",link:function(a,b,c){b[0].addEventListener("dragstart",a.handleNodeDragStart,!1),b[0].addEventListener("dragend",a.handleNodeDragEnd,!1)}}}).directive("nodeDroppable",function(){return{restrict:"A",link:function(a,b,c){b[0].addEventListener("drop",a.handleNodeDrop,!1),b[0].addEventListener("dragover",a.handleNodeDragOver,!1),b[0].addEventListener("dragenter",a.handleNodeDragEnter,!1),b[0].addEventListener("dragleave",a.handleNodeDragLeave,!1)}}}).controller("FileMappingCtrl",["$timeout","$resource","$log","$scope","$location","$rootScope","$sce","$http","nodePairResource","nodeRelationshipResource","AttributeOrder","solrFactory","solrService",function(a,b,c,d,e,f,g,h,i,j,k,l,m){d.nodeDropzones=null,d.currentNodePair=null,d.currentNodePairIndex=0,d.currentNodeRelationship=null,d.attributeOrderList=null,d.$onRootScope("nodeRelationshipChangedEvent",function(b,c){d.currentNodeRelationship=c,d.currentNodeRelationship&&(a(sizing,0),d.currentNodePairIndex=0,d.loadMapping(d.currentNodePairIndex),d.initializeNodeDropzones(d.currentWorkflow.input_relationships[0].set1,d.currentWorkflow.input_relationships[0].set2))}),d.initializeNodeDropzones=function(a,b){a=a||"",b=b||"",d.nodeDropzones={0:{name:a,color:"purple",attributes:null,uuid:null},1:{name:b,color:"green",attributes:null,uuid:null}}},d.initializeNodeDropzones(),d.isPending=function(){return null===d.currentNodePair},d.createMapping=function(){c.debug("Creating pair ... "),d.initializeNodeDropzones(d.currentWorkflow.input_relationships[0].set1,d.currentWorkflow.input_relationships[0].set2),d.currentNodePair=null,d.currentNodePairIndex=d.currentNodeRelationship.node_pairs.length},d.deleteMapping=function(){c.debug("Deleting pair ... "),d.currentNodePair&&(d.currentNodeRelationship.node_pairs.splice(d.currentNodePairIndex,1),j.update({uuid:d.currentNodeRelationship.uuid},d.currentNodeRelationship,function(){c.debug("Removed pair from node mapping."),d.hasNextMapping()?d.loadPreviousMapping():d.createMapping()},function(){c.error("Unable to remove pair "+d.currentNodeRelationship.uuid+" from mapping "+d.currentNodeRelationship.name)}),i["delete"]({uuid:d.currentNodePair.uuid},function(){c.debug("Deleted pair.")})),d.initializeNodeDropzones(d.currentWorkflow.input_relationships[0].set1,d.currentWorkflow.input_relationships[0].set2)},d.deleteAllMappings=function(){c.debug("Deleting mappings ... ");var a=d.currentNodeRelationship.node_pairs;d.currentNodeRelationship.node_pairs=[],j.update({uuid:d.currentNodeRelationship.uuid},d.currentNodeRelationship,function(){c.debug("Removed all pairs from node mapping."),d.createMapping()},function(){c.error("Unable to remove all pairs from mapping "+d.currentNodeRelationship.name)});for(var b=0;b<a.length;++b)i["delete"]({uuid:a[b].split("/").reverse()[1]});d.initializeNodeDropzones(d.currentWorkflow.input_relationships[0].set1,d.currentWorkflow.input_relationships[0].set2)},d.loadMapping=function(a){c.debug("Loading pair "+a+"... "),d.currentNodeRelationship.node_pairs.length>a?d.currentNodePair=b(d.currentNodeRelationship.node_pairs[a],{format:"json"}).get({},function(a){d.updateNodeDropzone(0,a.node1.split("/").reverse()[1]),d.updateNodeDropzone(1,a.node2.split("/").reverse()[1])},function(a){d.currentNodePair=null,console.error("Failed to load mapping.")}):(d.initializeNodeDropzones(),d.currentNodePair=null)},d.hasNextMapping=function(){return d.currentNodeRelationship.node_pairs.length<1?!1:!0},d.loadNextMapping=function(){d.hasNextMapping()&&(d.currentNodeRelationship.node_pairs.length<=++d.currentNodePairIndex&&(d.currentNodePairIndex=0),d.loadMapping(d.currentNodePairIndex))},d.loadPreviousMapping=function(){d.hasNextMapping()&&(0>--d.currentNodePairIndex&&(d.currentNodePairIndex=d.currentNodeRelationship.node_pairs.length-1),d.loadMapping(d.currentNodePairIndex))},d.updateNodeDropzone=function(a,b){d.nodeDropzones[a].uuid=b,d.loadNodeAttributes(b,d.attributeOrderList,function(b){var c=[];1==b.response.docs.length?angular.forEach(d.attributeOrderList,function(a){c.push({name:m.prettifyFieldName(a,!0),value:b.response.docs[0][a]})}):c=null,d.nodeDropzones[a].attributes=c},function(b){d.nodeDropzones[a].attributes=null})},d.handleNodeDragStart=function(a){this.style.opacity="0.4";var b=a.srcElement.attributes["node-uuid"].value;a.dataTransfer.setData("text/plain",JSON.stringify({uuid:b,html:this.innerHTML}))},d.handleNodeDragEnd=function(a){this.style.opacity="1.0"},d.handleNodeDrop=function(a){a.preventDefault(),a.stopPropagation(),this.style.opacity=1;var b=a.dataTransfer.getData("text/plain"),e=null,f=null;try{a.srcElement?f=a.srcElement.attributes["node-dropzone-index"].value:a.originalTarget?f=a.originalTarget.attributes["node-dropzone-index"].value:console.error("Unable to obtain dropzone index of droppable.")}catch(g){console.error("No dropzone index.")}try{e=JSON.parse(b)}catch(g){console.error("Parsing error: "+g)}d.updateNodeDropzone(f,e.uuid),d.nodeDropzones[0].uuid&&d.nodeDropzones[1].uuid&&(d.isPending()?(c.debug("Saving new file pair ..."),d.currentNodePair=new i({node1:"/api/v1/node/"+d.nodeDropzones[0].uuid+"/",node2:"/api/v1/node/"+d.nodeDropzones[1].uuid+"/"}),d.currentNodePair.$save(function(a,b){d.currentNodePair=a,d.currentNodeRelationship.node_pairs.push(d.currentNodePair.resource_uri),j.update({uuid:d.currentNodeRelationship.uuid},d.currentNodeRelationship),c.debug("New file pair saved.")})):(c.debug("Updating existing file pair ..."),d.currentNodePair.$save(function(a,b){d.currentNodePair=a,c.debug("Existing file pair updated.")}))),d.$apply()},d.handleNodeDragEnter=function(a){return a.preventDefault(),a.dataTransfer.dropEffect="move",this.style.opacity=.5,!1},d.handleNodeDragLeave=function(a){return a.preventDefault(),a.dataTransfer.dropEffect="move",this.style.opacity=1,!1},d.handleNodeDragOver=function(a){return a.preventDefault(),a.dataTransfer.dropEffect="move",!1},d.loadNodeAttributes=function(a,b,c,d){l.get({nodeUuid:a,attributeList:b.join()},function(a){c(a)},function(a){d(a)})};k.get({study__uuid:externalStudyUuid,assay__uuid:externalAssayUuid},function(a){d.attributeOrderList=[];for(var b=0;b<a.objects.length;++b)d.attributeOrderList.push(a.objects[b].solr_field)})}]).directive("diffAttributeList",["$log",function(a){return{templateUrl:"/static/partials/diff_attribute_list.tpls.html",restrict:"A",scope:{setA:"=",setB:"="},link:function(b,c,d){var e=function(){b.diffAttributes=[],b.commonAttributes=[];var c=0;if(a.debug("Updating diff lists ..."),null===b.setA.attributes&&null===b.setB.attributes)return void a.debug("Both sets empty");if(null===b.setB.attributes||null===b.setA.attributes)if(null!==b.setA.attributes)if(null!==b.setB.attributes);else for(c=0;c<b.setA.attributes.length;++c)b.commonAttributes.push({name:b.setA.attributes[c].name,value:b.setA.attributes[c].value});else for(c=0;c<b.setB.attributes.length;++c)b.commonAttributes.push({name:b.setB.attributes[c].name,value:b.setB.attributes[c].value});else for(c=0;c<b.setA.attributes.length;++c)b.setA.attributes[c].name===b.setB.attributes[c].name&&(b.setA.attributes[c].value===b.setB.attributes[c].value?b.commonAttributes.push({name:b.setA.attributes[c].name,value:b.setA.attributes[c].value}):b.diffAttributes.push({name:b.setA.attributes[c].name,valueSetA:b.setA.attributes[c].value,valueSetB:b.setB.attributes[c].value}))};b.$watch("setA.attributes",function(b,c){b&&!c&&(a.debug("Attribute setA initialized"),e()),c&&(a.debug("Attribute setA changed"),e())}),b.$watch("setB.attributes",function(b,c){b&&!c&&(a.debug("Attribute setB initialized"),e()),c&&(a.debug("Attribute setB changed"),e())})}}}]).controller("NodeSetListApiCtrl",["$scope","$rootScope","NodeSetList",function(a,b,c){"use strict";var d=c.get({study__uuid:externalStudyUuid,assay__uuid:externalAssayUuid},function(){a.nodesetList=d.objects});a.updateCurrentNodeSet=function(){a.currentNodeSet=a.nodesetList[a.nodesetIndex],a.currentNodeSet&&b.$emit("nodeSetChangedEvent",a.currentNodeSet)}}]).controller("DataSetUiModeCtrl",["$scope","$location","$rootScope",function(a,b,c){c.mode=DATA_SET_UI_MODE_BROWSE,a.$onRootScope("workflowChangedEvent",function(b,c){a.currentWorkflow=c}),a.$onRootScope("nodeRelationshipChangedEvent",function(b,c){a.currentNodeRelationship=c})}]).factory("NodeSetList",["$resource",function(a){"use strict";return a("/api/v1/nodesetlist/",{format:"json"})}]).factory("NodeSetFactory",["$resource",function(a){"use strict";return a("/api/v1/nodeset/",{format:"json"})}]).factory("AttributeOrder",["$resource",function(a){"use strict";return a("/api/v1/attributeorder/",{format:"json",is_internal:"false",is_exposed:"true"})}]).run(["$state",function(a,b){a.transitionTo("browse")}]);
//# sourceMappingURL=node_mapping.js.map